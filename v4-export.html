<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharia Brain - Export Tool</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
    }
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: #202621;
            color: #fff;
            min-height: 100vh;
            padding: 24px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            font-size: 1.5rem;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .subtitle {
            color: rgba(255,255,255,0.6);
            font-size: 0.875rem;
            margin-bottom: 24px;
        }
        
        .viewer {
            background: #202621;
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.1);
            overflow: hidden;
            position: relative;
            aspect-ratio: 1/1;
            max-width: 800px;
            margin: 0 auto 24px;
        }
        
        #canvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        .viewer-controls {
            position: absolute;
            bottom: 16px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
        }
        
        .viewer-btn {
            background: rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.2);
            color: #fff;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .viewer-btn:hover {
            background: rgba(0,0,0,0.7);
            border-color: rgba(255,255,255,0.4);
        }
        
        .viewer-btn svg {
            width: 18px;
            height: 18px;
        }
        
        .controls {
            max-width: 800px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
        }
        
        .control-group {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 16px;
        }
        
        .control-group label {
            display: block;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255,255,255,0.5);
            margin-bottom: 8px;
        }
        
        .control-group .value {
            float: right;
            color: rgba(255,255,255,0.8);
        }
        
        select {
            width: 100%;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: #fff;
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 0.875rem;
            cursor: pointer;
        }
        
        select option {
            background: #1a1d20;
        }
        
        input[type="range"] {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            background: rgba(255,255,255,0.15);
            border-radius: 3px;
            outline: none;
            margin-top: 4px;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: #A4C8FF;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #A4C8FF;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }
        
        .capture-btn {
            width: 100%;
            background: linear-gradient(135deg, #FFB974, #FF9A4D);
            border: none;
            color: #1a1d20;
            padding: 14px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .capture-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255,185,116,0.3);
        }
        
        .capture-btn svg {
            width: 18px;
            height: 18px;
        }
        
        .loading {
            position: absolute;
            inset: 0;
            background: #202621;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            color: rgba(255,255,255,0.5);
        }
        
        .loading.hidden {
            display: none;
        }
        
        .hint {
            text-align: center;
            font-size: 0.75rem;
            color: rgba(255,255,255,0.4);
            margin-top: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Pharia Brain Export</h1>
        <p class="subtitle">Export brain network images with transparent backgrounds for slides and decks</p>
        
        <div class="viewer">
            <div class="loading" id="loading">Loading brain model...</div>
            <canvas id="canvas"></canvas>
            <div class="viewer-controls">
                <button class="viewer-btn" id="play-pause-btn" title="Pause rotation">
                    <svg id="pause-icon" viewBox="0 0 24 24" fill="currentColor">
                        <rect x="6" y="4" width="4" height="16"/>
                        <rect x="14" y="4" width="4" height="16"/>
                    </svg>
                    <svg id="play-icon" viewBox="0 0 24 24" fill="currentColor" style="display:none;">
                        <polygon points="5,3 19,12 5,21"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label>Network</label>
                <select id="network-select">
                    <option value="left-cen">Left-CEN "The CEO"</option>
                    <option value="right-cen">Right-CEN "The Filter"</option>
                    <option value="salience">Salience "The Priority Switch"</option>
                    <option value="dmn">DMN "The Inner Critic"</option>
                    <option value="none">No Highlight (Ghost Only)</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>Ghost Opacity <span class="value" id="ghost-value">15%</span></label>
                <input type="range" id="ghost-opacity" min="0" max="50" value="15">
            </div>
            
            <div class="control-group">
                <label>Highlight Opacity <span class="value" id="highlight-value">95%</span></label>
                <input type="range" id="highlight-opacity" min="50" max="100" value="95">
            </div>
            
            <div class="control-group">
                <label>Resolution</label>
                <select id="resolution-select">
                    <option value="1024">1024 × 1024</option>
                    <option value="2048" selected>2048 × 2048</option>
                    <option value="4096">4096 × 4096</option>
                </select>
            </div>
            
            <div class="control-group">
                <button class="capture-btn" id="capture-btn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                        <circle cx="12" cy="13" r="4"/>
                    </svg>
                    Download PNG
                </button>
            </div>
        </div>
        
        <p class="hint">Drag to rotate • Scroll to zoom • Images export with transparent background</p>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // Network definitions
        const networks = {
            'left-cen': {
                color: '#A4C8FF',
                meshNames: [
                    'Allen_middle_frontal_gyrus_L',
                    'Allen_superior_frontal_gyrus_L',
                    'Allen_angular_gyrus_L',
                    'Allen_supramarginal_gyrus_L'
                ]
            },
            'right-cen': {
                color: '#8AB3F9',
                meshNames: [
                    'Allen_middle_frontal_gyrus_R',
                    'Allen_superior_frontal_gyrus_R',
                    'Allen_angular_gyrus_R',
                    'Allen_supramarginal_gyrus_R'
                ]
            },
            'salience': {
                color: '#FFB974',
                meshNames: [
                    'Allen_superior_frontal_gyrus_L',
                    'Allen_superior_frontal_gyrus_R',
                    'Allen_paracingulate_gyrus_L',
                    'Allen_paracingulate_gyrus_R',
                    'Allen_frontal_pole_L',
                    'Allen_frontal_pole_R',
                    'Allen_long_insular_gyri_L',
                    'Allen_long_insular_gyri_R',
                    'Allen_short_insular_gyri_L',
                    'Allen_short_insular_gyri_R',
                    'Allen_cingulate_gyrus_rostral_anterior_part_L',
                    'Allen_cingulate_gyrus_rostral_anterior_part_R'
                ]
            },
            'dmn': {
                color: '#C8D4C8',
                meshNames: [
                    'Allen_superior_frontal_gyrus_L',
                    'Allen_superior_frontal_gyrus_R',
                    'Allen_paracingulate_gyrus_L',
                    'Allen_paracingulate_gyrus_R',
                    'Allen_frontal_pole_L',
                    'Allen_frontal_pole_R',
                    'Allen_precuneus_L',
                    'Allen_precuneus_R',
                    'Allen_cingulate_gyrus_caudal_posterior_part_L',
                    'Allen_cingulate_gyrus_caudal_posterior_part_R',
                    'Allen_gyrus_rectus_straight_gyrus_L',
                    'Allen_gyrus_rectus_straight_gyrus_R',
                    'Allen_medial_orbital_gyrus_L',
                    'Allen_medial_orbital_gyrus_R'
                ]
            }
        };

        // Setup
        const canvas = document.getElementById('canvas');
        const container = canvas.parentElement;
        
        // Scene - NO background (null = transparent)
        const scene = new THREE.Scene();
        scene.background = null;
        
        // Camera
        const camera = new THREE.PerspectiveCamera(50, 1, 0.1, 100);
        camera.position.set(0, 0, 1.8);
        
        // Renderer - SIMPLE setup with alpha
        const renderer = new THREE.WebGLRenderer({
            canvas,
            antialias: true,
            alpha: true,
            preserveDrawingBuffer: true
        });
        renderer.setClearColor(0x000000, 0);
        renderer.setPixelRatio(window.devicePixelRatio);
        
        // Controls
        const controls = new OrbitControls(camera, canvas);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.enablePan = false;
        controls.autoRotate = true;
        controls.autoRotateSpeed = 0.5;
        
        // Lighting
        scene.add(new THREE.AmbientLight(0xffffff, 0.6));
        
        const light1 = new THREE.DirectionalLight(0xffffff, 0.8);
        light1.position.set(5, 5, 5);
        scene.add(light1);
        
        const light2 = new THREE.DirectionalLight(0x88aacc, 0.4);
        light2.position.set(-5, 3, -5);
        scene.add(light2);
        
        // Store meshes
        let allMeshes = [];
        let meshByName = {};
        let currentNetwork = 'left-cen';
        let ghostOpacity = 0.15;
        let highlightOpacity = 0.95;
        let isPlaying = true;
        
        // Load brain
        const loader = new GLTFLoader();
        loader.load('./brain.glb',
            (gltf) => {
                const model = gltf.scene;
                
                // Center and scale
                const box = new THREE.Box3().setFromObject(model);
                const size = box.getSize(new THREE.Vector3());
                const maxDim = Math.max(size.x, size.y, size.z);
                const scale = 1.5 / maxDim;
                model.scale.set(scale, scale, scale);
                
                const scaledBox = new THREE.Box3().setFromObject(model);
                const center = scaledBox.getCenter(new THREE.Vector3());
                model.position.set(-center.x, -center.y, -center.z);
                
                // Setup materials
                model.traverse((child) => {
                    if (child.isMesh) {
                        allMeshes.push(child);
                        meshByName[child.name] = child;
                        
                        // Default ghost material
                        child.material = new THREE.MeshLambertMaterial({
                            color: 0x5a6570,
                            transparent: true,
                            opacity: ghostOpacity,
                            side: THREE.DoubleSide
                        });
                    }
                });
                
                scene.add(model);
                highlightNetwork(currentNetwork);
                document.getElementById('loading').classList.add('hidden');
            },
            (progress) => {
                if (progress.total) {
                    const pct = Math.round((progress.loaded / progress.total) * 100);
                    document.getElementById('loading').textContent = `Loading: ${pct}%`;
                }
            },
            (error) => {
                console.error('Load error:', error);
                document.getElementById('loading').textContent = 'Error loading model';
            }
        );
        
        function highlightNetwork(networkId) {
            currentNetwork = networkId;
            
            // Reset all to ghost
            allMeshes.forEach(mesh => {
                mesh.material = new THREE.MeshLambertMaterial({
                    color: 0x5a6570,
                    transparent: true,
                    opacity: ghostOpacity,
                    side: THREE.DoubleSide
                });
            });
            
            // Highlight selected network
            if (networkId !== 'none' && networks[networkId]) {
                const net = networks[networkId];
                const color = new THREE.Color(net.color);
                
                net.meshNames.forEach(name => {
                    const mesh = meshByName[name];
                    if (mesh) {
                        mesh.material = new THREE.MeshLambertMaterial({
                            color: color,
                            transparent: true,
                            opacity: highlightOpacity,
                            side: THREE.DoubleSide
                        });
                    }
                });
            }
        }
        
        // Play/Pause toggle
        function togglePlayPause() {
            isPlaying = !isPlaying;
            controls.autoRotate = isPlaying;
            
            const playIcon = document.getElementById('play-icon');
            const pauseIcon = document.getElementById('pause-icon');
            const btn = document.getElementById('play-pause-btn');
            
            if (isPlaying) {
                playIcon.style.display = 'none';
                pauseIcon.style.display = 'block';
                btn.title = 'Pause rotation';
            } else {
                playIcon.style.display = 'block';
                pauseIcon.style.display = 'none';
                btn.title = 'Play rotation';
            }
        }
        
        // Capture function
        function capture() {
            const resolution = parseInt(document.getElementById('resolution-select').value);
            
            // Store original state
            const originalWidth = canvas.width;
            const originalHeight = canvas.height;
            const wasPlaying = isPlaying;
            
            // Stop rotation for capture
            controls.autoRotate = false;
            controls.update();
            
            // Resize for export
            renderer.setSize(resolution, resolution);
            renderer.setPixelRatio(1);
            camera.aspect = 1;
            camera.updateProjectionMatrix();
            
            // Render
            renderer.render(scene, camera);
            
            // Download
            const link = document.createElement('a');
            link.download = `pharia-brain-${currentNetwork}-${resolution}x${resolution}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            
            // Restore
            const size = Math.min(container.clientWidth, container.clientHeight);
            renderer.setSize(size, size);
            renderer.setPixelRatio(window.devicePixelRatio);
            camera.aspect = 1;
            camera.updateProjectionMatrix();
            
            // Restore rotation state
            controls.autoRotate = wasPlaying;
        }
        
        // Event listeners
        document.getElementById('network-select').addEventListener('change', (e) => {
            highlightNetwork(e.target.value);
        });
        
        document.getElementById('ghost-opacity').addEventListener('input', (e) => {
            ghostOpacity = parseInt(e.target.value) / 100;
            document.getElementById('ghost-value').textContent = e.target.value + '%';
            highlightNetwork(currentNetwork);
        });
        
        document.getElementById('highlight-opacity').addEventListener('input', (e) => {
            highlightOpacity = parseInt(e.target.value) / 100;
            document.getElementById('highlight-value').textContent = e.target.value + '%';
            highlightNetwork(currentNetwork);
        });
        
        document.getElementById('capture-btn').addEventListener('click', capture);
        document.getElementById('play-pause-btn').addEventListener('click', togglePlayPause);
        
        // Resize handler
        function resize() {
            const size = Math.min(container.clientWidth, container.clientHeight);
            renderer.setSize(size, size);
            camera.aspect = 1;
            camera.updateProjectionMatrix();
        }
        
        window.addEventListener('resize', resize);
        resize();
        
        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
